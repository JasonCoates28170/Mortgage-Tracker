<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime London Rentals - Financial Performance Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        h1 {
            color: #1e3c72;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: #1e3c72;
            color: white;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #1e3c72, #2a5298);
        }

        .metric-label {
            color: #666;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .metric-value {
            color: #1e3c72;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-subtext {
            font-size: 14px;
            color: #666;
        }

        .metric-change {
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .section-title {
            color: #1e3c72;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #e5e7eb;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1e3c72;
            color: white;
        }

        .btn-primary:hover {
            background: #2a5298;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .data-table tbody tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-enquiry {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-converted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-lost {
            background: #fee2e2;
            color: #991b1b;
        }

        .chart-container {
            height: 300px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            margin-top: 20px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, #1e3c72, #2a5298);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: all 0.3s;
            min-height: 20px;
        }

        .chart-bar:hover {
            opacity: 0.8;
            transform: translateY(-5px);
        }

        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 700;
            color: #1e3c72;
        }

        .roi-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .roi-positive {
            background: #d1fae5;
            color: #065f46;
        }

        .roi-negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar select, .filter-bar input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .summary-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #1e3c72;
        }

        .summary-item-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .summary-item-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e3c72;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .export-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th, .data-table td {
                padding: 8px;
            }
        }

        .property-tag {
            display: inline-block;
            padding: 4px 10px;
            background: #eff6ff;
            color: #1e40af;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
        }

        .icon {
            font-size: 20px;
            margin-right: 8px;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quick-stat {
            text-align: center;
        }

        .quick-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e3c72;
        }

        .quick-stat-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Prime London Rentals - Financial Performance Tracker</h1>
            <p class="subtitle">Google Ads Investment & Booking Revenue Analytics</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('apartments')">üè† Apartments</button>
            <button class="tab" onclick="showTab('adspend')">üí≥ Ad Spend</button>
            <button class="tab" onclick="showTab('enquiries')">üìû Enquiries</button>
            <button class="tab" onclick="showTab('bookings')">‚úÖ Bookings</button>
            <button class="tab" onclick="showTab('analytics')">üìà Analytics</button>
            <button class="tab" onclick="showTab('reports')">üìã Reports</button>
        </div>

        <!-- Apartments Tab -->
        <div id="apartments" class="content-section">
            <div class="card">
                <h2 class="section-title">Add New Apartment</h2>
                <form onsubmit="addApartment(event)" class="form-grid">
                    <div class="form-group">
                        <label>Apartment Reference *</label>
                        <input type="text" id="aptReference" placeholder="e.g., KEN-2B-01" required>
                    </div>
                    <div class="form-group">
                        <label>Property Name</label>
                        <input type="text" id="aptName" placeholder="e.g., Kensington Gardens Apartment">
                    </div>
                    <div class="form-group">
                        <label>Location/Area *</label>
                        <select id="aptLocation" required>
                            <option value="">Select Area</option>
                            <option value="Kensington">Kensington</option>
                            <option value="Knightsbridge">Knightsbridge</option>
                            <option value="Chelsea">Chelsea</option>
                            <option value="South Kensington">South Kensington</option>
                            <option value="Notting Hill">Notting Hill</option>
                            <option value="Belgravia">Belgravia</option>
                            <option value="Hyde Park">Hyde Park</option>
                            <option value="Lancaster Gate">Lancaster Gate</option>
                            <option value="Mayfair">Mayfair</option>
                            <option value="Westminster">Westminster</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Property Type *</label>
                        <select id="aptType" required>
                            <option value="">Select Type</option>
                            <option value="Studio">Studio</option>
                            <option value="1 Bed">1 Bedroom</option>
                            <option value="2 Bed">2 Bedrooms</option>
                            <option value="3 Bed">3 Bedrooms</option>
                            <option value="4 Bed">4 Bedrooms</option>
                            <option value="Penthouse">Penthouse</option>
                            <option value="Mews">Mews House</option>
                            <option value="Duplex">Duplex</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max Guests</label>
                        <input type="number" id="aptGuests" min="1" placeholder="4">
                    </div>
                    <div class="form-group">
                        <label>Standard Nightly Rate (¬£)</label>
                        <input type="number" id="aptRate" step="0.01" placeholder="250.00">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="aptStatus">
                            <option value="active">Active</option>
                            <option value="maintenance">Under Maintenance</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Address</label>
                        <input type="text" id="aptAddress" placeholder="Full address">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Amenities / Features</label>
                        <textarea id="aptAmenities" rows="2" placeholder="e.g., WiFi, Parking, Garden, Air Conditioning..."></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Notes</label>
                        <textarea id="aptNotes" rows="2" placeholder="Additional information..."></textarea>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">‚ûï Add Apartment</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2 class="section-title">Apartment Portfolio</h2>
                <div class="filter-bar">
                    <label style="font-weight: 600;">Location:</label>
                    <select id="aptLocationFilter" onchange="renderApartments()">
                        <option value="all">All Locations</option>
                        <option value="Kensington">Kensington</option>
                        <option value="Knightsbridge">Knightsbridge</option>
                        <option value="Chelsea">Chelsea</option>
                        <option value="South Kensington">South Kensington</option>
                        <option value="Notting Hill">Notting Hill</option>
                        <option value="Belgravia">Belgravia</option>
                        <option value="Hyde Park">Hyde Park</option>
                        <option value="Lancaster Gate">Lancaster Gate</option>
                    </select>
                    <label style="font-weight: 600;">Status:</label>
                    <select id="aptStatusFilter" onchange="renderApartments()">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="maintenance">Under Maintenance</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Property Name</th>
                                <th>Location</th>
                                <th>Type</th>
                                <th>Max Guests</th>
                                <th>Nightly Rate</th>
                                <th>Status</th>
                                <th>Total Bookings</th>
                                <th>Total Revenue</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="apartmentsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="content-section active">
            <div class="month-selector">
                <label style="font-weight: 600;">View Period:</label>
                <select id="dashboardPeriod" onchange="updateDashboard()">
                    <option value="current">Current Month</option>
                    <option value="last">Last Month</option>
                    <option value="3months">Last 3 Months</option>
                    <option value="6months">Last 6 Months</option>
                    <option value="ytd">Year to Date</option>
                    <option value="all">All Time</option>
                </select>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">üí≥ Total Ad Spend</div>
                    <div class="metric-value">¬£<span id="totalAdSpend">0</span></div>
                    <div class="metric-subtext">Google Ads Investment</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üìû Total Enquiries</div>
                    <div class="metric-value" id="totalEnquiries">0</div>
                    <div class="metric-subtext">Sales Leads Generated</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">‚úÖ Converted Bookings</div>
                    <div class="metric-value" id="totalBookings">0</div>
                    <div class="metric-subtext"><span id="conversionRate">0%</span> Conversion Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üí∞ Total Revenue</div>
                    <div class="metric-value">¬£<span id="totalRevenue">0</span></div>
                    <div class="metric-subtext">From Converted Bookings</div>
                </div>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">üìä Cost Per Enquiry</div>
                    <div class="metric-value">¬£<span id="costPerEnquiry">0</span></div>
                    <div class="metric-subtext">Ad Spend √∑ Enquiries</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üíµ Cost Per Booking</div>
                    <div class="metric-value">¬£<span id="costPerBooking">0</span></div>
                    <div class="metric-subtext">Ad Spend √∑ Bookings</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üìà Return on Ad Spend</div>
                    <div class="metric-value"><span id="roas">0</span>x</div>
                    <div class="metric-subtext">Revenue √∑ Ad Spend</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üíé Net Profit</div>
                    <div class="metric-value">¬£<span id="netProfit">0</span></div>
                    <div class="metric-subtext">Revenue - Ad Spend</div>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">Performance Overview</h2>
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="avgBookingValue">¬£0</div>
                        <div class="quick-stat-label">Avg Booking Value</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="avgNightsBooked">0</div>
                        <div class="quick-stat-label">Avg Nights</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="totalNightsBooked">0</div>
                        <div class="quick-stat-label">Total Nights</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="enquiryToBooking">0%</div>
                        <div class="quick-stat-label">Close Rate</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">Monthly Trend</h2>
                <div class="chart-container" id="monthlyChart"></div>
            </div>
        </div>

        <!-- Ad Spend Tab -->
        <div id="adspend" class="content-section">
            <div class="card">
                <h2 class="section-title">Record Ad Spend</h2>
                <form onsubmit="addAdSpend(event)" class="form-grid">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="adDate" required>
                    </div>
                    <div class="form-group">
                        <label>Campaign Name</label>
                        <input type="text" id="adCampaign" placeholder="e.g., Kensington Luxury" required>
                    </div>
                    <div class="form-group">
                        <label>Amount (¬£)</label>
                        <input type="number" id="adAmount" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>Clicks</label>
                        <input type="number" id="adClicks" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Impressions</label>
                        <input type="number" id="adImpressions" placeholder="0">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">‚ûï Add Ad Spend</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2 class="section-title">Ad Spend History</h2>
                <div class="filter-bar">
                    <label style="font-weight: 600;">Filter:</label>
                    <select id="adSpendFilter" onchange="renderAdSpend()">
                        <option value="all">All Campaigns</option>
                    </select>
                    <input type="month" id="adSpendMonth" onchange="renderAdSpend()">
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Campaign</th>
                                <th>Amount</th>
                                <th>Clicks</th>
                                <th>Impressions</th>
                                <th>CPC</th>
                                <th>CTR</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adSpendTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Enquiries Tab -->
        <div id="enquiries" class="content-section">
            <div class="card">
                <h2 class="section-title">Record New Enquiry</h2>
                <form onsubmit="addEnquiry(event)" class="form-grid">
                    <div class="form-group">
                        <label>Date Received</label>
                        <input type="date" id="enquiryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Guest Name</label>
                        <input type="text" id="enquiryName" placeholder="Guest name" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="enquiryEmail" placeholder="guest@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="enquiryPhone" placeholder="+44...">
                    </div>
                    <div class="form-group">
                        <label>Apartment Reference</label>
                        <select id="enquiryProperty">
                            <option value="">Loading apartments...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <select id="enquirySource">
                            <option value="google">Google Ads</option>
                            <option value="organic">Organic Search</option>
                            <option value="airbnb">Airbnb</option>
                            <option value="booking">Booking.com</option>
                            <option value="direct">Direct</option>
                            <option value="referral">Referral</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Check-in Date</label>
                        <input type="date" id="enquiryCheckin">
                    </div>
                    <div class="form-group">
                        <label>Check-out Date</label>
                        <input type="date" id="enquiryCheckout">
                    </div>
                    <div class="form-group">
                        <label>Estimated Value (¬£)</label>
                        <input type="number" id="enquiryEstValue" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Notes</label>
                        <textarea id="enquiryNotes" rows="2" placeholder="Additional information..."></textarea>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">‚ûï Add Enquiry</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2 class="section-title">Enquiry Pipeline</h2>
                <div class="filter-bar">
                    <label style="font-weight: 600;">Status:</label>
                    <select id="enquiryStatusFilter" onchange="renderEnquiries()">
                        <option value="all">All Enquiries</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="quoted">Quoted</option>
                        <option value="converted">Converted</option>
                        <option value="lost">Lost</option>
                    </select>
                    <label style="font-weight: 600;">Source:</label>
                    <select id="enquirySourceFilter" onchange="renderEnquiries()">
                        <option value="all">All Sources</option>
                        <option value="google">Google Ads</option>
                        <option value="organic">Organic</option>
                        <option value="airbnb">Airbnb</option>
                        <option value="booking">Booking.com</option>
                        <option value="direct">Direct</option>
                        <option value="referral">Referral</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Guest</th>
                                <th>Property</th>
                                <th>Check-in</th>
                                <th>Nights</th>
                                <th>Est. Value</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="enquiriesTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div id="bookings" class="content-section">
            <div class="card">
                <h2 class="section-title">Convert Enquiry to Booking</h2>
                <div class="alert alert-info">
                    Select an enquiry from the dropdown or create a direct booking below.
                </div>
                <form onsubmit="addBooking(event)" class="form-grid">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Convert from Enquiry (Optional)</label>
                        <select id="bookingEnquiry">
                            <option value="">-- Create New Direct Booking --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Booking Date</label>
                        <input type="date" id="bookingDate" required>
                    </div>
                    <div class="form-group">
                        <label>Guest Name</label>
                        <input type="text" id="bookingName" placeholder="Guest name" required>
                    </div>
                    <div class="form-group">
                        <label>Apartment Reference *</label>
                        <select id="bookingProperty" required>
                            <option value="">Loading apartments...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Check-in Date</label>
                        <input type="date" id="bookingCheckin" required>
                    </div>
                    <div class="form-group">
                        <label>Check-out Date</label>
                        <input type="date" id="bookingCheckout" required>
                    </div>
                    <div class="form-group">
                        <label>Number of Nights</label>
                        <input type="number" id="bookingNights" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Nightly Rate (¬£)</label>
                        <input type="number" id="bookingRate" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>Total Revenue (¬£)</label>
                        <input type="number" id="bookingRevenue" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>Booking Source</label>
                        <select id="bookingSource">
                            <option value="google">Google Ads</option>
                            <option value="organic">Organic Search</option>
                            <option value="airbnb">Airbnb</option>
                            <option value="booking">Booking.com</option>
                            <option value="direct">Direct</option>
                            <option value="referral">Referral</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Booking Notes</label>
                        <textarea id="bookingNotes" rows="2" placeholder="Special requests, payment details, etc."></textarea>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-success" style="width: 100%;">‚úÖ Confirm Booking</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2 class="section-title">Confirmed Bookings</h2>
                <div class="filter-bar">
                    <label style="font-weight: 600;">Period:</label>
                    <input type="month" id="bookingMonth" onchange="renderBookings()">
                    <label style="font-weight: 600;">Property:</label>
                    <select id="bookingPropertyFilter" onchange="renderBookings()">
                        <option value="all">All Properties</option>
                        <option value="Kensington">Kensington</option>
                        <option value="Knightsbridge">Knightsbridge</option>
                        <option value="Chelsea">Chelsea</option>
                        <option value="South Kensington">South Kensington</option>
                        <option value="Notting Hill">Notting Hill</option>
                        <option value="Belgravia">Belgravia</option>
                        <option value="Hyde Park">Hyde Park</option>
                        <option value="Lancaster Gate">Lancaster Gate</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Booking Date</th>
                                <th>Guest</th>
                                <th>Property</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Nights</th>
                                <th>Rate/Night</th>
                                <th>Revenue</th>
                                <th>Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="content-section">
            <div class="card">
                <h2 class="section-title">Campaign Performance Analysis</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-item-label">Best Performing Campaign</div>
                        <div class="summary-item-value" id="bestCampaign">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">Highest ROAS</div>
                        <div class="summary-item-value" id="highestROAS">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">Most Popular Property</div>
                        <div class="summary-item-value" id="popularProperty">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-label">Peak Booking Month</div>
                        <div class="summary-item-value" id="peakMonth">--</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">Source Performance Breakdown</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Enquiries</th>
                                <th>Bookings</th>
                                <th>Conversion Rate</th>
                                <th>Revenue</th>
                                <th>Ad Spend</th>
                                <th>ROAS</th>
                            </tr>
                        </thead>
                        <tbody id="sourceAnalyticsTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">Property Performance</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Enquiries</th>
                                <th>Bookings</th>
                                <th>Total Nights</th>
                                <th>Avg Nightly Rate</th>
                                <th>Total Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="propertyAnalyticsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="content-section">
            <div class="card">
                <h2 class="section-title">Generate Reports</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Report Type</label>
                        <select id="reportType">
                            <option value="monthly">Monthly Summary</option>
                            <option value="quarterly">Quarterly Review</option>
                            <option value="annual">Annual Report</option>
                            <option value="campaign">Campaign Analysis</option>
                            <option value="property">Property Performance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="reportEndDate">
                    </div>
                </div>
                <div class="export-section">
                    <button class="btn btn-primary" onclick="exportData('csv')">üì• Export CSV</button>
                    <button class="btn btn-primary" onclick="exportData('json')">üì• Export JSON</button>
                    <button class="btn btn-secondary" onclick="generateReport()">üìÑ Generate PDF Report</button>
                    <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print Report</button>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">Quick Insights</h2>
                <div id="quickInsights"></div>
            </div>

            <div class="card">
                <h2 class="section-title">Performance Goals</h2>
                <form class="form-grid">
                    <div class="form-group">
                        <label>Monthly Revenue Target (¬£)</label>
                        <input type="number" id="revenueGoal" step="0.01" placeholder="50000.00">
                    </div>
                    <div class="form-group">
                        <label>Monthly Booking Target</label>
                        <input type="number" id="bookingGoal" placeholder="20">
                    </div>
                    <div class="form-group">
                        <label>Target ROAS</label>
                        <input type="number" id="roasGoal" step="0.1" placeholder="5.0">
                    </div>
                    <div class="form-group">
                        <label>Max Cost Per Booking (¬£)</label>
                        <input type="number" id="cpbGoal" step="0.01" placeholder="500.00">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveGoals()" style="width: 100%;">üíæ Save Goals</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Data structures
        let apartments = [];
        let adSpend = [];
        let enquiries = [];
        let bookings = [];
        let goals = {
            revenue: 50000,
            bookings: 20,
            roas: 5.0,
            cpb: 500
        };

        // Initialize
        async function init() {
            await loadData();
            setDefaultDates();
            updateApartmentDropdowns();
            updateDashboard();
            renderApartments();
            renderAdSpend();
            renderEnquiries();
            renderBookings();
            updateEnquiryDropdown();
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('adDate').value = today;
            document.getElementById('enquiryDate').value = today;
            document.getElementById('bookingDate').value = today;
        }

        // Storage functions
        async function loadData() {
            try {
                const aptData = await window.storage.get('financial-apartments');
                if (aptData) apartments = JSON.parse(aptData.value);

                const adData = await window.storage.get('financial-adspend');
                if (adData) adSpend = JSON.parse(adData.value);

                const enqData = await window.storage.get('financial-enquiries');
                if (enqData) enquiries = JSON.parse(enqData.value);

                const bookData = await window.storage.get('financial-bookings');
                if (bookData) bookings = JSON.parse(bookData.value);

                const goalsData = await window.storage.get('financial-goals');
                if (goalsData) goals = JSON.parse(goalsData.value);
            } catch (error) {
                console.log('No saved data, using defaults');
            }
        }

        async function saveData() {
            try {
                await window.storage.set('financial-apartments', JSON.stringify(apartments));
                await window.storage.set('financial-adspend', JSON.stringify(adSpend));
                await window.storage.set('financial-enquiries', JSON.stringify(enquiries));
                await window.storage.set('financial-bookings', JSON.stringify(bookings));
                await window.storage.set('financial-goals', JSON.stringify(goals));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Apartment functions
        function addApartment(event) {
            event.preventDefault();

            const newApartment = {
                id: Date.now(),
                reference: document.getElementById('aptReference').value.toUpperCase(),
                name: document.getElementById('aptName').value,
                location: document.getElementById('aptLocation').value,
                type: document.getElementById('aptType').value,
                guests: parseInt(document.getElementById('aptGuests').value) || 0,
                rate: parseFloat(document.getElementById('aptRate').value) || 0,
                status: document.getElementById('aptStatus').value,
                address: document.getElementById('aptAddress').value,
                amenities: document.getElementById('aptAmenities').value,
                notes: document.getElementById('aptNotes').value,
                dateAdded: new Date().toISOString()
            };

            apartments.push(newApartment);
            saveData();
            renderApartments();
            updateApartmentDropdowns();
            event.target.reset();
            alert('Apartment added successfully!');
        }

        function renderApartments() {
            const tbody = document.getElementById('apartmentsTable');
            tbody.innerHTML = '';

            const locationFilter = document.getElementById('aptLocationFilter')?.value || 'all';
            const statusFilter = document.getElementById('aptStatusFilter')?.value || 'all';

            let filteredApts = apartments;
            if (locationFilter !== 'all') {
                filteredApts = filteredApts.filter(apt => apt.location === locationFilter);
            }
            if (statusFilter !== 'all') {
                filteredApts = filteredApts.filter(apt => apt.status === statusFilter);
            }

            filteredApts.sort((a, b) => a.reference.localeCompare(b.reference)).forEach(apt => {
                // Calculate apartment statistics
                const aptBookings = bookings.filter(b => b.apartmentRef === apt.reference);
                const totalBookings = aptBookings.length;
                const totalRevenue = aptBookings.reduce((sum, b) => sum + b.revenue, 0);

                const statusClass = apt.status === 'active' ? 'status-converted' : 
                                   apt.status === 'maintenance' ? 'status-enquiry' : 'status-lost';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${apt.reference}</strong></td>
                    <td>${apt.name || '--'}</td>
                    <td><span class="property-tag">${apt.location}</span></td>
                    <td>${apt.type}</td>
                    <td>${apt.guests || '--'}</td>
                    <td>¬£${apt.rate.toFixed(2)}</td>
                    <td><span class="status-badge ${statusClass}">${apt.status}</span></td>
                    <td>${totalBookings}</td>
                    <td><strong>¬£${totalRevenue.toFixed(2)}</strong></td>
                    <td>
                        <button class="btn btn-secondary" onclick="editApartment(${apt.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteApartment(${apt.id})">Delete</button>
                    </td>
                `;
            });
        }

        function updateApartmentDropdowns() {
            // Update enquiry property dropdown
            const enquirySelect = document.getElementById('enquiryProperty');
            if (enquirySelect) {
                enquirySelect.innerHTML = '<option value="">Select Apartment</option>';
                apartments.filter(apt => apt.status === 'active').forEach(apt => {
                    const option = document.createElement('option');
                    option.value = apt.reference;
                    option.textContent = `${apt.reference} - ${apt.location} ${apt.type}`;
                    enquirySelect.appendChild(option);
                });
            }

            // Update booking property dropdown
            const bookingSelect = document.getElementById('bookingProperty');
            if (bookingSelect) {
                bookingSelect.innerHTML = '<option value="">Select Apartment</option>';
                apartments.filter(apt => apt.status === 'active').forEach(apt => {
                    const option = document.createElement('option');
                    option.value = apt.reference;
                    option.textContent = `${apt.reference} - ${apt.location} ${apt.type}`;
                    bookingSelect.appendChild(option);
                });
            }
        }

        function editApartment(id) {
            const apt = apartments.find(a => a.id === id);
            if (!apt) return;

            document.getElementById('aptReference').value = apt.reference;
            document.getElementById('aptName').value = apt.name || '';
            document.getElementById('aptLocation').value = apt.location;
            document.getElementById('aptType').value = apt.type;
            document.getElementById('aptGuests').value = apt.guests || '';
            document.getElementById('aptRate').value = apt.rate || '';
            document.getElementById('aptStatus').value = apt.status;
            document.getElementById('aptAddress').value = apt.address || '';
            document.getElementById('aptAmenities').value = apt.amenities || '';
            document.getElementById('aptNotes').value = apt.notes || '';

            // Delete the old one
            apartments = apartments.filter(a => a.id !== id);
            saveData();
            renderApartments();
            
            // Scroll to form
            document.getElementById('apartments').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteApartment(id) {
            const apt = apartments.find(a => a.id === id);
            if (!apt) return;

            // Check if apartment has bookings
            const aptBookings = bookings.filter(b => b.apartmentRef === apt.reference);
            if (aptBookings.length > 0) {
                if (!confirm(`This apartment has ${aptBookings.length} booking(s). Are you sure you want to delete it?`)) {
                    return;
                }
            }

            if (confirm(`Delete apartment ${apt.reference}?`)) {
                apartments = apartments.filter(a => a.id !== id);
                saveData();
                renderApartments();
                updateApartmentDropdowns();
            }
        }

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        // Ad Spend functions
        function addAdSpend(event) {
            event.preventDefault();
            
            const newAd = {
                id: Date.now(),
                date: document.getElementById('adDate').value,
                campaign: document.getElementById('adCampaign').value,
                amount: parseFloat(document.getElementById('adAmount').value),
                clicks: parseInt(document.getElementById('adClicks').value) || 0,
                impressions: parseInt(document.getElementById('adImpressions').value) || 0
            };

            adSpend.push(newAd);
            saveData();
            renderAdSpend();
            updateDashboard();
            event.target.reset();
            setDefaultDates();
        }

        function renderAdSpend() {
            const tbody = document.getElementById('adSpendTable');
            tbody.innerHTML = '';

            adSpend.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(ad => {
                const cpc = ad.clicks > 0 ? (ad.amount / ad.clicks).toFixed(2) : '0.00';
                const ctr = ad.impressions > 0 ? ((ad.clicks / ad.impressions) * 100).toFixed(2) : '0.00';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(ad.date).toLocaleDateString()}</td>
                    <td>${ad.campaign}</td>
                    <td><strong>¬£${ad.amount.toFixed(2)}</strong></td>
                    <td>${ad.clicks}</td>
                    <td>${ad.impressions.toLocaleString()}</td>
                    <td>¬£${cpc}</td>
                    <td>${ctr}%</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editAdSpend(${ad.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteAdSpend(${ad.id})">Delete</button>
                    </td>
                `;
            });
        }

        function deleteAdSpend(id) {
            if (confirm('Delete this ad spend entry?')) {
                adSpend = adSpend.filter(ad => ad.id !== id);
                saveData();
                renderAdSpend();
                updateDashboard();
            }
        }

        // Enquiry functions
        function addEnquiry(event) {
            event.preventDefault();

            const checkin = document.getElementById('enquiryCheckin').value;
            const checkout = document.getElementById('enquiryCheckout').value;
            const nights = checkin && checkout ? 
                Math.ceil((new Date(checkout) - new Date(checkin)) / (1000 * 60 * 60 * 24)) : 0;

            const apartmentRef = document.getElementById('enquiryProperty').value;

            const newEnquiry = {
                id: Date.now(),
                date: document.getElementById('enquiryDate').value,
                name: document.getElementById('enquiryName').value,
                email: document.getElementById('enquiryEmail').value,
                phone: document.getElementById('enquiryPhone').value,
                apartmentRef: apartmentRef,
                property: apartmentRef, // Keep for backward compatibility
                source: document.getElementById('enquirySource').value,
                checkin: checkin,
                checkout: checkout,
                nights: nights,
                estimatedValue: parseFloat(document.getElementById('enquiryEstValue').value) || 0,
                notes: document.getElementById('enquiryNotes').value,
                status: 'new'
            };

            enquiries.push(newEnquiry);
            saveData();
            renderEnquiries();
            updateEnquiryDropdown();
            updateDashboard();
            event.target.reset();
            setDefaultDates();
        }

        function renderEnquiries() {
            const tbody = document.getElementById('enquiriesTable');
            tbody.innerHTML = '';

            enquiries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(enq => {
                const displayProperty = enq.apartmentRef || enq.property;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(enq.date).toLocaleDateString()}</td>
                    <td>${enq.name}</td>
                    <td><span class="property-tag">${displayProperty}</span></td>
                    <td>${enq.checkin ? new Date(enq.checkin).toLocaleDateString() : '--'}</td>
                    <td>${enq.nights || '--'}</td>
                    <td><strong>¬£${enq.estimatedValue.toFixed(2)}</strong></td>
                    <td>${enq.source}</td>
                    <td><span class="status-badge status-${enq.status}">${enq.status}</span></td>
                    <td>
                        <select onchange="updateEnquiryStatus(${enq.id}, this.value)">
                            <option value="new" ${enq.status === 'new' ? 'selected' : ''}>New</option>
                            <option value="contacted" ${enq.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                            <option value="quoted" ${enq.status === 'quoted' ? 'selected' : ''}>Quoted</option>
                            <option value="converted" ${enq.status === 'converted' ? 'selected' : ''}>Converted</option>
                            <option value="lost" ${enq.status === 'lost' ? 'selected' : ''}>Lost</option>
                        </select>
                        <button class="btn btn-danger" onclick="deleteEnquiry(${enq.id})">Delete</button>
                    </td>
                `;
            });
        }

        function updateEnquiryStatus(id, status) {
            const enquiry = enquiries.find(e => e.id === id);
            if (enquiry) {
                enquiry.status = status;
                saveData();
                renderEnquiries();
                updateDashboard();
            }
        }

        function deleteEnquiry(id) {
            if (confirm('Delete this enquiry?')) {
                enquiries = enquiries.filter(e => e.id !== id);
                saveData();
                renderEnquiries();
                updateEnquiryDropdown();
                updateDashboard();
            }
        }

        function updateEnquiryDropdown() {
            const select = document.getElementById('bookingEnquiry');
            select.innerHTML = '<option value="">-- Create New Direct Booking --</option>';
            
            enquiries.filter(e => e.status !== 'converted' && e.status !== 'lost')
                .forEach(enq => {
                    const option = document.createElement('option');
                    option.value = enq.id;
                    const displayProperty = enq.apartmentRef || enq.property;
                    option.textContent = `${enq.name} - ${displayProperty} (${new Date(enq.date).toLocaleDateString()})`;
                    select.appendChild(option);
                });
        }

        // Booking functions
        function addBooking(event) {
            event.preventDefault();

            const enquiryId = document.getElementById('bookingEnquiry').value;
            const nights = parseInt(document.getElementById('bookingNights').value);
            const rate = parseFloat(document.getElementById('bookingRate').value);
            const revenue = parseFloat(document.getElementById('bookingRevenue').value);
            const apartmentRef = document.getElementById('bookingProperty').value;

            const newBooking = {
                id: Date.now(),
                enquiryId: enquiryId,
                date: document.getElementById('bookingDate').value,
                name: document.getElementById('bookingName').value,
                apartmentRef: apartmentRef,
                property: apartmentRef, // Keep for backward compatibility
                checkin: document.getElementById('bookingCheckin').value,
                checkout: document.getElementById('bookingCheckout').value,
                nights: nights,
                rate: rate,
                revenue: revenue,
                source: document.getElementById('bookingSource').value,
                notes: document.getElementById('bookingNotes').value
            };

            bookings.push(newBooking);

            // Update enquiry status if converted from enquiry
            if (enquiryId) {
                const enquiry = enquiries.find(e => e.id === parseInt(enquiryId));
                if (enquiry) {
                    enquiry.status = 'converted';
                }
            }

            saveData();
            renderBookings();
            renderEnquiries();
            renderApartments();
            updateEnquiryDropdown();
            updateDashboard();
            event.target.reset();
            setDefaultDates();
        }

        function renderBookings() {
            const tbody = document.getElementById('bookingsTable');
            tbody.innerHTML = '';

            bookings.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(booking => {
                const displayProperty = booking.apartmentRef || booking.property;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(booking.date).toLocaleDateString()}</td>
                    <td>${booking.name}</td>
                    <td><span class="property-tag">${displayProperty}</span></td>
                    <td>${new Date(booking.checkin).toLocaleDateString()}</td>
                    <td>${new Date(booking.checkout).toLocaleDateString()}</td>
                    <td>${booking.nights}</td>
                    <td>¬£${booking.rate.toFixed(2)}</td>
                    <td><strong>¬£${booking.revenue.toFixed(2)}</strong></td>
                    <td>${booking.source}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteBooking(${booking.id})">Delete</button>
                    </td>
                `;
            });
        }

        function deleteBooking(id) {
            if (confirm('Delete this booking?')) {
                const booking = bookings.find(b => b.id === id);
                if (booking && booking.enquiryId) {
                    const enquiry = enquiries.find(e => e.id === parseInt(booking.enquiryId));
                    if (enquiry) {
                        enquiry.status = 'quoted';
                    }
                }
                bookings = bookings.filter(b => b.id !== id);
                saveData();
                renderBookings();
                renderEnquiries();
                renderApartments();
                updateEnquiryDropdown();
                updateDashboard();
            }
        }

        // Dashboard functions
        function updateDashboard() {
            const totalAdSpendValue = adSpend.reduce((sum, ad) => sum + ad.amount, 0);
            const totalEnquiriesValue = enquiries.length;
            const totalBookingsValue = bookings.length;
            const totalRevenueValue = bookings.reduce((sum, b) => sum + b.revenue, 0);

            document.getElementById('totalAdSpend').textContent = totalAdSpendValue.toFixed(2);
            document.getElementById('totalEnquiries').textContent = totalEnquiriesValue;
            document.getElementById('totalBookings').textContent = totalBookingsValue;
            document.getElementById('totalRevenue').textContent = totalRevenueValue.toFixed(2);

            const conversionRate = totalEnquiriesValue > 0 ? 
                ((totalBookingsValue / totalEnquiriesValue) * 100).toFixed(1) : 0;
            document.getElementById('conversionRate').textContent = conversionRate + '%';

            const costPerEnquiry = totalEnquiriesValue > 0 ? 
                (totalAdSpendValue / totalEnquiriesValue).toFixed(2) : 0;
            document.getElementById('costPerEnquiry').textContent = costPerEnquiry;

            const costPerBooking = totalBookingsValue > 0 ? 
                (totalAdSpendValue / totalBookingsValue).toFixed(2) : 0;
            document.getElementById('costPerBooking').textContent = costPerBooking;

            const roas = totalAdSpendValue > 0 ? 
                (totalRevenueValue / totalAdSpendValue).toFixed(2) : 0;
            document.getElementById('roas').textContent = roas;

            const netProfit = totalRevenueValue - totalAdSpendValue;
            document.getElementById('netProfit').textContent = netProfit.toFixed(2);

            const avgBookingValue = totalBookingsValue > 0 ? 
                (totalRevenueValue / totalBookingsValue).toFixed(2) : 0;
            document.getElementById('avgBookingValue').textContent = '¬£' + avgBookingValue;

            const totalNights = bookings.reduce((sum, b) => sum + b.nights, 0);
            const avgNights = totalBookingsValue > 0 ? 
                (totalNights / totalBookingsValue).toFixed(1) : 0;
            document.getElementById('avgNightsBooked').textContent = avgNights;
            document.getElementById('totalNightsBooked').textContent = totalNights;

            document.getElementById('enquiryToBooking').textContent = conversionRate + '%';

            updateMonthlyChart();
        }

        function updateMonthlyChart() {
            const chartDiv = document.getElementById('monthlyChart');
            chartDiv.innerHTML = '';

            // Group data by month
            const monthlyData = {};
            
            bookings.forEach(booking => {
                const month = booking.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { revenue: 0, bookings: 0 };
                }
                monthlyData[month].revenue += booking.revenue;
                monthlyData[month].bookings += 1;
            });

            const months = Object.keys(monthlyData).sort().slice(-6);
            const maxRevenue = Math.max(...months.map(m => monthlyData[m].revenue), 1);

            months.forEach(month => {
                const data = monthlyData[month];
                const height = (data.revenue / maxRevenue) * 100;
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = height + '%';
                bar.innerHTML = `
                    <div class="chart-bar-value">¬£${data.revenue.toFixed(0)}</div>
                    <div class="chart-bar-label">${new Date(month).toLocaleDateString('en-GB', { month: 'short' })}</div>
                `;
                chartDiv.appendChild(bar);
            });
        }

        // Analytics functions
        function updateAnalytics() {
            updateSourceAnalytics();
            updatePropertyAnalytics();
        }

        function updateSourceAnalytics() {
            const tbody = document.getElementById('sourceAnalyticsTable');
            tbody.innerHTML = '';

            const sources = ['google', 'organic', 'airbnb', 'booking', 'direct', 'referral', 'other'];
            
            sources.forEach(source => {
                const sourceEnquiries = enquiries.filter(e => e.source === source);
                const sourceBookings = bookings.filter(b => b.source === source);
                const sourceRevenue = sourceBookings.reduce((sum, b) => sum + b.revenue, 0);
                const sourceAdSpend = adSpend.filter(ad => source === 'google').reduce((sum, ad) => sum + ad.amount, 0);
                const sourceConversion = sourceEnquiries.length > 0 ? 
                    ((sourceBookings.length / sourceEnquiries.length) * 100).toFixed(1) : 0;
                const sourceROAS = sourceAdSpend > 0 ? 
                    (sourceRevenue / sourceAdSpend).toFixed(2) : '--';

                if (sourceEnquiries.length > 0 || sourceBookings.length > 0) {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${source.charAt(0).toUpperCase() + source.slice(1)}</strong></td>
                        <td>${sourceEnquiries.length}</td>
                        <td>${sourceBookings.length}</td>
                        <td>${sourceConversion}%</td>
                        <td>¬£${sourceRevenue.toFixed(2)}</td>
                        <td>${source === 'google' ? '¬£' + sourceAdSpend.toFixed(2) : '--'}</td>
                        <td>${sourceROAS !== '--' ? sourceROAS + 'x' : '--'}</td>
                    `;
                }
            });
        }

        function updatePropertyAnalytics() {
            const tbody = document.getElementById('propertyAnalyticsTable');
            tbody.innerHTML = '';

            const properties = {};

            enquiries.forEach(enq => {
                const propKey = enq.apartmentRef || enq.property;
                if (!properties[propKey]) {
                    properties[propKey] = { enquiries: 0, bookings: 0, nights: 0, revenue: 0 };
                }
                properties[propKey].enquiries++;
            });

            bookings.forEach(booking => {
                const propKey = booking.apartmentRef || booking.property;
                if (!properties[propKey]) {
                    properties[propKey] = { enquiries: 0, bookings: 0, nights: 0, revenue: 0 };
                }
                properties[propKey].bookings++;
                properties[propKey].nights += booking.nights;
                properties[propKey].revenue += booking.revenue;
            });

            Object.keys(properties).sort().forEach(property => {
                const data = properties[property];
                const avgRate = data.nights > 0 ? (data.revenue / data.nights).toFixed(2) : 0;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${property}</strong></td>
                    <td>${data.enquiries}</td>
                    <td>${data.bookings}</td>
                    <td>${data.nights}</td>
                    <td>¬£${avgRate}</td>
                    <td>¬£${data.revenue.toFixed(2)}</td>
                `;
            });
        }

        // Export functions
        function exportData(format) {
            if (format === 'csv') {
                let csv = 'Type,Date,Details,Amount\n';
                
                adSpend.forEach(ad => {
                    csv += `Ad Spend,${ad.date},"${ad.campaign}",${ad.amount}\n`;
                });
                
                bookings.forEach(booking => {
                    csv += `Booking,${booking.date},"${booking.name} - ${booking.property}",${booking.revenue}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'financial-data.csv';
                a.click();
            } else if (format === 'json') {
                const data = {
                    adSpend: adSpend,
                    enquiries: enquiries,
                    bookings: bookings,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'financial-data.json';
                a.click();
            }
        }

        function generateReport() {
            alert('PDF report generation would integrate with a PDF library. Export to CSV for now and create reports in Excel/Google Sheets.');
        }

        function printReport() {
            window.print();
        }

        function saveGoals() {
            goals.revenue = parseFloat(document.getElementById('revenueGoal').value) || goals.revenue;
            goals.bookings = parseInt(document.getElementById('bookingGoal').value) || goals.bookings;
            goals.roas = parseFloat(document.getElementById('roasGoal').value) || goals.roas;
            goals.cpb = parseFloat(document.getElementById('cpbGoal').value) || goals.cpb;
            
            saveData();
            alert('Goals saved successfully!');
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
